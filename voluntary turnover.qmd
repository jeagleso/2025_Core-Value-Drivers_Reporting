---
title: "Voluntary Turnover"
format: html
editor: visual
---

```{r}
#| label: setup
#| warning: false
library(tidyverse)

# specify period: first date of current year and last day of previous month
start_date <- as.Date(floor_date(Sys.Date(), "year"))
end_date <- as.Date("2025-02-28")
# end_date <- as.Date(floor_date(Sys.Date(), "month") - days(1))

# get all months included in period
months_included <- seq(start_date, end_date, by = "month")

# get the last date of each month
last_day_of_month <- ceiling_date(months_included, "month") - days(1)

# data frame with all months
monthly_data <- tibble(last_day_of_month = as.Date(last_day_of_month))

# filters to be applied
# filter() does not include NA by default
apply_filters <- function(df) {
  df |>  
    filter(worker_type == "Employee") |> 
    filter((job_family_group != "Human Resources") |> replace_na(TRUE))
}
```

```{r}
#| label: get_data

# get active and terminated, add career_level bucket
active_and_terminated <- readxl::read_xlsx("inputs/People Analytics - AT.xlsx", skip = 4) |> 
  janitor::clean_names() |> 
  mutate(career_level_bucket = factor(case_when(
    career_level %in% c("E2", "E3", "E4", "E5") ~ "VP",
    career_level %in% c("M5", "E1") ~ "Director",
    career_level %in% c("M2", "M3", "M4") ~ "Manager",
    career_level == "M1" ~ "Supervisor",
    career_level %in% c("P1", "P2", "P3", "P4", "P5", "P6") ~ "Professional",
    career_level %in% c("AT1", "AT2", "AT3", "AT4") ~ "Administrative_Technical",
    is.na(career_level) ~ "None",
    TRUE ~ "ERROR_unmapped_level"),
    levels = c("VP", "Director", "Manager", "Supervisor", "Professional", "Administrative_Technical", "None", "ERROR_unmapped_level"),
    ordered = TRUE))

pa_at <- active_and_terminated |> 
  apply_filters()
```

```{r}
#| label: calculate_turnover_at_file

tmp <- map_df(last_day_of_month, function(date) {
  
  headcount <- pa_at |> 
    filter(hire_date <= date & (is.na(termination_date) | termination_date >= date)) |> 
    group_by(segment_function) |> 
    summarize(headcount = n(), .groups = 'drop')

  voluntary_terminations <- pa_at |> 
    filter(termination_category == "Terminate Employee > Voluntary" &
          termination_date >= floor_date(date, "month") &
          termination_date <= date) |> 
    group_by(segment_function) |> 
    summarize(voluntary_terminations = n(), .groups = 'drop')

  result <- left_join(headcount, voluntary_terminations, by = "segment_function") |> 
    mutate(
      date = date,
      voluntary_terminations = coalesce(voluntary_terminations, 0),
      voluntary_turnover = voluntary_terminations / headcount
      )
  
  return(result)
})


# monthly turnover rate for enterprise
monthly_turnover_rate_at_file <- monthly_data |>
  rowwise() |> 
  mutate(
    previous_month = floor_date(last_day_of_month, unit = "month") - days(1),
    voluntary_terminations = sum(!is.na(pa_at$termination_date) & 
                        pa_at$termination_category == "Terminate Employee > Voluntary" &
                       pa_at$termination_date <= last_day_of_month & 
                       pa_at$termination_date > previous_month),
    headcount = sum(pa_at$hire_date <= last_day_of_month & 
                      (is.na(pa_at$termination_date) |
                         pa_at$termination_date >= last_day_of_month))) |> 
  ungroup() |> 
  mutate(voluntary_turnover = voluntary_terminations / headcount)

```

FAQ:

-   Associates are included in headcount if their termination day is on or after the last day of the month (e.g., an Associate will be included in January's headcount if their termination date is 1/31 or later).

```{r}
jan_hc <- readxl::read_xlsx("C:/Users/610171734/OneDrive - Regal Rexnord/Documents/2024/2024_Core Value Drivers_Reporting/inputs/2024_HC/RRX - Data Validation_1 JAN2024 2024-01-31.xlsx", sheet = "Raw Data", skip = 17) |> 
  janitor::clean_names()

tmp <- jan_hc |> 
  filter(segment_function_l1 != "Industrial Systems") |> 
  filter(worker_type == "Employee")

# Filter to include only employees in the effective date headcount
tmp_headcount <- active_and_terminated_employees %>%
  filter(hire_date <= "2024-01-31" & 
         (is.na(termination_date) | termination_date >= "2024-01-31"))

# Write the filtered data to a CSV file
write.csv(tmp_headcount, "tmp_jan_headcount.csv", row.names = FALSE)
```

# HIPO Jerry Morton

```{r}
a_t_aip <- active_and_terminated |> 
  filter(x9box_numeric %in% c("3.3", "3.2", "2.3")) |> 
  filter(x9box_potential != "Too New To Rate" & 
           x9box_potential != "New to Company") |> 
  filter(management_chain_level_2 == "Jerry Morton")

# assumes running YTD through last full month of current year
months_included <- seq(floor_date(Sys.Date(), "year"), 
          floor_date(Sys.Date(), "month") - days(1), by = "month")

last_day_of_month <- ceiling_date(months_included, "month") - days(1)

# data frame with all months
monthly_data <- tibble(last_day_of_month = last_day_of_month)

monthly_turnover_rate_at_file <- monthly_data |>
  rowwise() |> 
  mutate(
    previous_month = floor_date(last_day_of_month, unit = "month") - days(1),
    terminations = sum(!is.na(a_t_aip$termination_date) & 
                       a_t_aip$termination_date <= last_day_of_month & 
                       a_t_aip$termination_date > previous_month),
    headcount = sum(a_t_aip$hire_date <= last_day_of_month & 
                      (is.na(a_t_aip$termination_date) |
                         a_t_aip$termination_date >= last_day_of_month))) |> 
  ungroup() |> 
  mutate(turnover_rate = terminations / headcount)
```

### Future Ideas

- Create a function to make an active file and term file for each month from the AT file

- Possible to embed in body of email to flag for HRBP VPs?